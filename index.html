<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta name="description" content="Create your tile map with this online Tile Map Editor" />
    <link rel="stylesheet" href="src/styles.css" />

    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#317EFB">
    <link rel="apple-touch-icon" href="/icon.png">
    <style>
      * {
        box-sizing: border-box;
      }

      html {
        width: 100%;
        height: 100%;
      }

      body {
        overflow: hidden;
        height: 100%;
        overscroll-behavior-y: none;
        margin: 0;
      }
    </style>
    <script src="src/tilemap-editor.js"></script>

    <title>TileMapEditor.js</title>
  </head>
  <body>
  <div id="tileMapEditor"></div>
  <button id="addPwaBtn" >üç∞ Install pwa</button>
  <script>
    // upload to imgur, then return the src
    const uploadImageToImgur = (blob) => {
      const formData = new FormData();
      formData.append('type', 'file');
      formData.append('image', blob);
      return fetch('https://api.imgur.com/3/upload.json', {
        method: 'POST',
        headers: {
          Accept: 'application/json',
          Authorization: 'Client-ID 1bddacd2afe5039'// imgur specific
        },
        body: formData
      }).then(response =>{
                if (response.status === 200 || response.status === 0) return Promise.resolve(response);
                return Promise.reject(new Error("Error loading image"))
              }).then(response=>response.json())
    };

    console.log(window)
    const tilesetImageImgr = "https://i.imgur.com/ztwPZOI.png";
    const tilesetImageLocal = "./free.png";

    // Example exporter
    const kaboomJsExporter = {
      // The export menu entry name
      name: "kaboomJs boilerplate",
      // Here you convert the data to the structure you need it to be
      transformer: (data) => {
        let kaboomData = data;

        // Then you simply return the result. It can be any type of data
        return kaboomData
      },
      //passTo controls what happens to the exported data
      // "clipboard" simply copies the result in the user's clipboard
      // "file" saves it as a file
      // "apply" passes it to and triggers the onApply callback
      passTo: "clipboard", // it can be "file" || "apply"
    }
    TilemapEditor.init("tileMapEditor",{
      tileSize:32,
      mapWidth: 20,
      tileSetImages: [tilesetImageImgr, tilesetImageLocal],
      applyButtonText: "OK",
      exporters: {kaboomJsExporter}, // These turn into menu options for exporting data
      // You can write your own tilemap export function here, if you dont, tilemap-edit will simply download the data to your fs
      onApply:console.log,
      // You can write your own custom load image function here and use it for the tileset src. If you dont, the base64 string will be used instead
      tileSetLoaders: {
        fromUrl: {
          name: "Any url", // name is required and used for the loader's title in the select menu
          prompt: (setSrc) => { // Pass prompt ot onSelectImage. Prompt lets you do anything without asking the user to select a file
            const fileUrl = window.prompt("What is the url of the tileset?", "https://i.imgur.com/ztwPZOI.png");
            if(fileUrl !== null) setSrc(fileUrl)
          }
        },
        imgur: {
          name: "Imgur (host)",
          onSelectImage: (setSrc, file, base64) => { // In case you want them to give you a file from the fs, you can do this instead of prompt
            uploadImageToImgur(file).then(result=>{
              console.log(file, base64);
              console.log("Uploaded to imgur", result);
              setSrc(result.data.link);
            });
          },
        },
      }
    })

    // Pwa stuff
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker
              .register('/tilemap-editor/sw.js')
              .then(() => { console.log('Service Worker Registered'); });
    }
    let deferredPrompt;
    const addBtn = document.getElementById("addPwaBtn");
    addBtn.style.display = 'none';
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      addBtn.style.display = 'block';
      addBtn.addEventListener('click', () => {
        addBtn.style.display = 'none';
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('User accepted the A2HS prompt');
          }
          deferredPrompt = null;
        });
      });
    });
    window.addEventListener('appinstalled', () => {
      addBtn.style.display = 'none';
      deferredPrompt = null;
      console.log('PWA was installed');
    });

  </script>

  <style>
    #addPwaBtn {
      position: absolute;
      bottom: 10px;
      left: 50%;
      background: #1a1a1a;
      color: yellow;
      border: 1px solid grey;
      border-radius: 3px;
      padding: 10px;
    }
  </style>

  </body>
</html>
